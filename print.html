<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>â„ ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰â„</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> ğŸ README.md</a></li><li class="chapter-item expanded "><a href="config.html"><strong aria-hidden="true">2.</strong> ğŸ§¾é…ç½®ï¼ˆConfigurationsï¼‰</a></li><li class="chapter-item expanded "><a href="builders/index.html"><strong aria-hidden="true">3.</strong> ğŸ”¨æ„å»ºæ¡†æ¶ï¼ˆBuildersï¼‰</a></li><li class="chapter-item expanded "><a href="benchmarks/index.html"><strong aria-hidden="true">4.</strong> ğŸ“ˆåŸºå‡†æµ‹è¯•ï¼ˆBenchmarksï¼‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="benchmarks/spec2006.html"><strong aria-hidden="true">4.1.</strong> SPEC CPU 2006</a></li></ol></li><li class="chapter-item expanded "><a href="running/index.html"><strong aria-hidden="true">5.</strong> ğŸ’½è¿è¡Œé•œåƒï¼ˆRunning Imagesï¼‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="running/gem5.html"><strong aria-hidden="true">5.1.</strong> GEM5</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">â„ ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰â„</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/OpenXiangShan/Deterload" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ç¡®å®šæ€§è´Ÿè½½deterload"><a class="header" href="#ç¡®å®šæ€§è´Ÿè½½deterload">ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰</a></h1>
<p><strong>ç¡®å®šæ€§è´Ÿè½½</strong>ï¼ˆDeterloadï¼‰æ˜¯ä¸€ä¸ªä¸ºé¦™å±±ç”Ÿæ€ï¼ˆåŒ…æ‹¬
<a href="https://docs.xiangshan.cc">é¦™å±±å¤„ç†å™¨</a>ã€
<a href="https://github.com/OpenXiangShan/NEMU">é¦™å±±NEMU</a>
å’Œ<a href="https://github.com/OpenXiangShan/GEM5">é¦™å±±GEM5</a>
ï¼‰ç”Ÿæˆ<strong>ç¡®å®šæ€§å·¥ä½œè´Ÿè½½</strong>çš„æ¡†æ¶ã€‚</p>
<p><strong>Deterload</strong> is a framework for generating <strong>Deterministic Workloads</strong> for the XiangShan ecosystem (including
<a href="https://github.com/OpenXiangShan/XiangShan">XiangShan Processor</a>,
<a href="https://github.com/OpenXiangShan/NEMU">XiangShan NEMU</a>,
and <a href="https://github.com/OpenXiangShan/GEM5">XiangShan GEM5</a>
).</p>
<h2 id="èƒŒæ™¯background"><a class="header" href="#èƒŒæ™¯background">èƒŒæ™¯ï¼ˆBackgroundï¼‰</a></h2>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">é¦™å±±</a>æ˜¯ä¸€æ¬¾å¼€æºçš„é«˜æ€§èƒ½RISC-Vå¤„ç†å™¨ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯æ•æ·å¼€å‘ã€‚
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">é¦™å±±çš„å·¥ä½œè´Ÿè½½</a>æŒ‡è¿è¡Œåœ¨é¦™å±±å¤„ç†å™¨ä¸Šçš„å„ç±»ç¨‹åºï¼Œæ˜¯å¼€å‘ã€è°ƒè¯•ã€è¯„ä¼°ã€ç ”ç©¶æ—¶ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚</p>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">XiangShan</a> is an open-source high-performance RISC-V processor, built around the core concept of agile development.
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">XiangShan's workloads</a> refer to various programs running on XiangShan processor,
which are essential components for development, debugging, evaluation, and research.</p>
<p>ä¸ºäº†èƒ½æ›´åŠ æ•æ·åœ°ç”Ÿæˆå„ç±»å·¥ä½œè´Ÿè½½ï¼Œæˆ‘ä»¬å¼€å‘äº†Deterloadé¡¹ç›®ã€‚
Deterloadåœ¨<a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a>æ¡†æ¶ä¸Šï¼Œå¼•å…¥äº†<strong>ç¡®å®šæ€§</strong>ã€‚
æ­¤å¤–ï¼ŒDeterloadä¸ä»…æ”¯æŒç”Ÿæˆåˆ‡ç‰‡é•œåƒï¼Œè¿˜è®¡åˆ’æ”¯æŒé¦™å±±çš„å„ç±»å·¥ä½œè´Ÿè½½ï¼ŒåŒ…æ‹¬éåˆ‡ç‰‡é•œåƒå’Œè£¸æœºé•œåƒã€‚</p>
<p>To enable more agile generation of various workloads, we developed the Deterload project.
Deterload is based on the <a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a> framework and adds the <strong>deterministic</strong> feature.
Moreover, Deterload not only supports generating checkpoint images but also plans to support various workloads for XiangShan, including non-checkpoint images and bare-metal images.</p>
<h2 id="å…³äºç¡®å®šæ€§about-deterministic"><a class="header" href="#å…³äºç¡®å®šæ€§about-deterministic">å…³äºâ€œç¡®å®šæ€§â€ï¼ˆAbout "Deterministic"ï¼‰</a></h2>
<p>ğŸ¤”<strong>ä»€ä¹ˆ</strong>æ˜¯â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºæ— è®ºä½•æ—¶ä½•åœ°ï¼Œä¸¤æ¬¡æ„å»ºåŒä¸€ä¸ªå·¥ä½œè´Ÿè½½ï¼Œéƒ½åº”è¯¥å¾—åˆ°å®Œå…¨ç›¸åŒçš„ç»“æœï¼</p>
<p>ğŸ¤”<strong>ä¸ºä»€ä¹ˆ</strong>éœ€è¦â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºå®ƒèƒ½è®©å¼€å‘æ›´æ•æ·ã€‚æ— è®ºä½•æ—¶ä½•åœ°ï¼Œä½ éƒ½èƒ½è½»æ¾é‡ç°bugå’Œæ€§èƒ½å¼‚å¸¸ï¼</p>
<p>ğŸ¤”<strong>å¦‚ä½•</strong>å®ç°â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºä½¿ç”¨ç¡®å®šæ€§åŒ…ç®¡ç†å™¨<a href="https://nixos.org/">Nix</a>å¹¶ä¸”æ§åˆ¶æ‰€æœ‰éšæœºæ€§ï¼</p>
<p>ğŸ¤”<strong>What</strong> is "Deterministic"?
ğŸ˜ºIt means that whenever and wherever building the workload twice should yield the same result!</p>
<p>ğŸ¤”<strong>Why</strong> do we need "Deterministic"?
ğŸ˜ºIt enables more agile development.
You can reproduce bugs and performance anomalies anytime, anywhere, without hassle!</p>
<p>ğŸ¤”<strong>How</strong> to achieve "Deterministic"?
ğŸ˜ºUsing the deterministic package manager <a href="https://nixos.org/">Nix</a> and controlling all possible sources of randomness!</p>
<h2 id="ä½¿ç”¨æ–¹æ³•usage"><a class="header" href="#ä½¿ç”¨æ–¹æ³•usage">ä½¿ç”¨æ–¹æ³•ï¼ˆUsageï¼‰</a></h2>
<p>Deterloadç”±Nixé©±åŠ¨ã€‚
å¦‚æœä½ å°šæœªå®‰è£…Nixï¼Œè¯·å‚è€ƒ<a href="https://nixos.org/download/">Nixå®˜æ–¹å®‰è£…æŒ‡å—</a>ã€‚</p>
<p>Deterload is powered by Nix.
If you haven't installed Nix, please refer to the <a href="https://nixos.org/download/">Nix official installation</a>.</p>
<pre><code class="language-bash"># è¿›å…¥nix shellï¼ˆæ¨èä½¿ç”¨direnvè‡ªåŠ¨è¿›å…¥nix shellï¼‰ï¼š
# Enter the nix shell (direnv is recommended for auto entering the nix shell):
nix-shell

# ç”¨10ä¸ªçº¿ç¨‹ä¸º&lt;benchmark&gt;ç”Ÿæˆåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡å­˜äºresult/ï¼š
# Generate checkpoints for &lt;benchmark&gt; using 10 threads, saved in result/:
nom-build -A &lt;benchmark&gt; -j10

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼š
# Display help information:
h
</code></pre>
<p>å…³äºå¦‚ä½•è¿è¡Œç”Ÿæˆçš„åˆ‡ç‰‡é•œåƒï¼Œè¯·å‚è€ƒ<a href="./running/index.html">ğŸ’½è¿è¡Œé•œåƒ</a>ã€‚</p>
<p>For instructions on running the generated checkpoint images, please refer to <a href="./running/index.html">ğŸ’½Running Images</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é…ç½®configurations"><a class="header" href="#é…ç½®configurations">ğŸ§¾é…ç½®ï¼ˆConfigurationsï¼‰</a></h1>
<p>TODO:</p>
<p>Priority:</p>
<ul>
<li>CLI Configurations</li>
<li>Benchmark-Specific Configurations</li>
<li>Global Configurations</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºæ¡†æ¶builders"><a class="header" href="#æ„å»ºæ¡†æ¶builders">ğŸ”¨æ„å»ºæ¡†æ¶ï¼ˆBuildersï¼‰</a></h1>
<p><img src="builders/./images/overview_py.svg" alt="" /></p>
<p><img src="builders/./images/deps_py.svg" alt="" /></p>
<p>TODO:</p>
<p>The project uses Nix to manage dependencies and build the necessary components:</p>
<ul>
<li>QEMU: Modified version of QEMU with checkpoint and profiling capabilities</li>
<li>Simpoint: Simpoint is a tool for profiling and checkpointing in XiangShan</li>
<li>OpenSBI: RISC-V OpenSBI firmware</li>
<li>Linux: Custom Linux kernel image</li>
<li>Profiling tools: Scripts and plugins for analyzing checkpoint data</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åŸºå‡†æµ‹è¯•benchmarks"><a class="header" href="#åŸºå‡†æµ‹è¯•benchmarks">ğŸ“ˆåŸºå‡†æµ‹è¯•ï¼ˆBenchmarksï¼‰</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><p>TODO:</p>
<h2 id="preparing-spec-cpu2006-source-code"><a class="header" href="#preparing-spec-cpu2006-source-code">Preparing SPEC CPU2006 Source Code</a></h2>
<p>Before using this project, you need to prepare the SPEC CPU2006 program source code yourself. Please follow these steps:</p>
<ol>
<li>Obtain the SPEC CPU2006 source code (we cannot provide the source code due to licensing restrictions).</li>
<li>It is recommended to store the SPEC CPU2006 source code directory separately, not in the same location as this repository.</li>
<li>Rename the obtained source code folder to "spec2006", like ~/workspace/spec2006.</li>
<li>Please do not modify the SPEC CPU2006 source code, as this may cause the build to fail.</li>
<li>Note that the spec2006/default.nix directory in this repository is different from the SPEC CPU2006 source code directory. The former can be considered as a Nix build script.</li>
</ol>
<p>Note: Generating checkpoints may take several or more than ten hours, depending on the complexity of the benchmark.</p>
<p>Please note that the build process may take a considerable amount of time:</p>
<ol>
<li>
<p>First, the script will fetch and compile the RISC-V GCC toolchain, Linux kernel, QEMU, and other necessary components. This step takes approximately 1 hour.</p>
</li>
<li>
<p>Then, it will use QEMU for profiling, SimPoint sampling, and QEMU checkpoint generation. Generating spec2006 ref input checkpoint typically requires about 10 hours.</p>
</li>
</ol>
<p>If you want to quickly test the system, you can start by setting the input size to "test":</p>
<ol>
<li>Edit the <code>conf.nix</code> file</li>
<li>Change <code>size = xxx</code> to <code>size = "test"</code></li>
</ol>
<p>With the test input size, the entire process should complete in about 30 minutes.</p>
<p>Finally, it will generate a result folder, you will get all the checkpoints in the result folder</p>
<p>If you want to back up some checkpoints:
run</p>
<pre><code class="language-bash">nom-build -j 30
python3 backup_checkpoints.py
</code></pre>
<p>It will copy checkpoints from nix path to local pwd path, named backup_XXX (timestamp).
Notice: backup_XXX is about 100GB!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿è¡Œé•œåƒrunning-images"><a class="header" href="#è¿è¡Œé•œåƒrunning-images">ğŸ’½è¿è¡Œé•œåƒï¼ˆRunning Imagesï¼‰</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="running-on-gem5"><a class="header" href="#running-on-gem5">Running on Gem5</a></h2>
<p>The checkpoints generated by this repository can be run on Gem5, Nemu, and XiangShan RTL in the XiangShan repository. Here we explain the considerations for running on Gem5.</p>
<p>Since the checkpoints in this repository are currently single-core and without V extension (will be updated once vector extension support is stable), please configure according to the README in https://github.com/OpenXiangShan/GEM5.</p>
<p>Note: This repository's checkpoints by default place the checkpoint restorer code at the beginning of the checkpoint address space (refer to opensbi/default.nix). Therefore, there's no need to specify the $GCB_RESTORER environment variable; you can set it to empty.</p>
<p>If you encounter difftest errors during Gem5 execution, you can follow these steps:</p>
<ol>
<li>Visit the Gem5 releases page</li>
<li>Download a stable version of NEMU</li>
<li>Set the corresponding <code>$GCBV_REF_SO</code> environment variable</li>
</ol>
<p>This approach can help resolve difftest errors and ensure proper execution of checkpoints on Gem5.</p>
<p>If you encounter other Gem5 runtime errors, try debugging by adding <code>gdb --args</code> before the gem5 command. You can also open an issue in this repository or the Gem5 repository.</p>
<p>Please note that some checkpoints may fail to run in Gem5. This issue is currently being addressed. However, over 90% of the checkpoints should run correctly, and the resulting scores should be generally accurate. After running all checkpoints in Gem5, you can use the following script to calculate the SPEC CPU 2006 slice scores:</p>
<p>https://github.com/shinezyy/gem5_data_proc</p>
<p>You may need to make some minor modifications to this repository, as gem5_data_proc is designed for internal checkpoints, and there are slight differences in file naming between it and the Nix checkpoints. For example, "hmmer" vs "456.hmmer".</p>
<p>This script can help you process the data generated by Gem5 and calculate the final scores for the SPEC CPU 2006 benchmark. Even if a few checkpoints fail to run, this script should still provide you with a fairly accurate performance assessment.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
